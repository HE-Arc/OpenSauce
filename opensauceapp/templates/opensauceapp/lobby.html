{% extends "opensauceapp/base.html" %}
{% block title %}Lobby {% endblock %}

{% block content %}
<style>

</style>

<div id="currentQuestion">

</div>
<div id="scoreBoard-container">
    <ul id="scoreBoard">
    </ul>
</div>
<div id="timeRemaining">

</div>
<input id="joinButton" type="button" value="Rejoindre">
<input id="pseudoField" type="text" placeholder="Pseudo">
<input id="leaveButton" type="button" value="Quitter" hidden>
<input id="submitAnswer" type="text" hidden>

<script>
	let lobbyName = {{lobby_name_json}};
    let currentTimeEnd;

	let lobbySocket = new WebSocket("ws://" + window.location.host + "/ws/lobby/" + lobbyName + "/");

	let scoreBoard = document.getElementById("scoreBoard");
	let currentQuestion = document.getElementById("currentQuestion");

	let submitAnswer = document.getElementById("submitAnswer");
	let joinButton = document.getElementById("joinButton");
	let leaveButton = document.getElementById("leaveButton");

	joinButton.addEventListener("click", join);
	leaveButton.addEventListener("click", leave);

	lobbySocket.onmessage = function(e) {
		let data = JSON.parse(e.data);
        console.log(data);
        if(data.type == "game_state")
        {
            updateGameStatus(data.state);
        }
	};

	lobbySocket.onclose = function(e) {
		console.error("Lobby socket closed unexpectedly");
	};

	submitAnswer.focus();
	submitAnswer.addEventListener("keydown", function(e) {
        let message = e.srcElement.value;
		if (e.keyCode === 13 && message.length > 0) {
			sendAnswer(message);
            e.srcElement.value = "";
		}
	});

	function sendAnswer(answer) {
		lobbySocket.send(JSON.stringify({
			"type": "submit",
			"answer": answer,
		}));
	}

	function join() {
		updateUiControls(true);
		lobbySocket.send(JSON.stringify({
			"type": "join",
			"pseudo": pseudoField.value
		}));
	}

	function leave() {
		updateUiControls(false);
        lobbySocket.send(JSON.stringify({
			"type": "leave"
		}));
	}

	function updateUiControls(isPlaying) {
        pseudoField.hidden = isPlaying;
		joinButton.hidden = isPlaying;
		leaveButton.hidden = !isPlaying;
        submitAnswer.hidden = !isPlaying;
	}

    function updateGameStatus(data) {
        updateScoreBoard(data["players"]);
        updateTimeEnd(data["questionDateTimeEnd"]);
        updateQuestion(data["currentQuestion"]);
    }

    function updateTimeEnd(timeEnd)
    {
        currentTimeEnd = Date.parse(timeEnd);
    }

    function updateQuestion(question)
    {
        currentQuestion.innerHTML = question;
    }

    function updateScoreBoard(players) {
        scoreBoard.innerHTML = '';
        for(let i = 0; i < players.length; i++)
        {
            let player = players[i];
            let playerLi = document.createElement("li");
            playerLi.innerHTML = player["name"] + " : " + player.score + " (" + player.pointsThisRound + ")";
            scoreBoard.appendChild(playerLi)
        }
    }
</script>
{% endblock %}
