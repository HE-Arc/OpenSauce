{% extends "opensauceapp/base.html" %}
{% block title %}Lobby {% endblock %}

{% block content %}
<style>
	html, body {
        width:100%;
        height:100%;
    }

    #left_container {
        float:left;
        width: 70%;
        height: 100%;
        margin:0;
    }
    #right_container {
        float:right;
        width: 30%;
        height: 100%;
        margin:0;
    }

    #header {

    }

    #current_question {
        height: 80%;
        text-align: center;
        font-size: 50px;
    }

    #submit_answer {
        width: 100%;
        margin: 50px;
        font-size: 2em;
        text-align: center;
        border-radius: 25px;
        background-color:black;
        color:white;
        text-transform: uppercase;
    }

    .scoreboard_table {
        width:100%;
    }
</style>
<div id="left_container">
	<div id="header">
		<div id="lobby_name">
			Lobby : {% autoescape on %}
			{{lobby_name}}
			{% endautoescape %}
		</div>
		<div id="game_message">
		</div>
	</div>

	<div id="category">

	</div>
	<div id="date_time">

	</div>
	<div id="current_question">

	</div>

	<input id="submit_answer" type="text" hidden>
</div>
<div id="right_container">
	<span id="when_disconnected">
		Nom : <input id="pseudo_field" type="text" placeholder="john">
		<input id="join_button" type="button" value="Rejoindre">
	</span>
	<span id="when_connected" hidden>
		Connecté en tant que : <span id="current_pseudo"></span>
		<input id="leave_button" type="button" value="Quitter">
	</span>
	<div id="players_table-container">
		<p class="h3">Joueurs</p>
		<table id="players_table" class="table scoreboard_table">
		</table>
	</div>
	<div id="spectators_table-container">
		<p class="h3">Spectateurs</p>
		<table id="spectators_table" class="table scoreboard_table">
		</table>
	</div>
	<div id="history_table-container">
		<p class="h3">Historique</p>
		<table id="history_table" class="table scoreboard_table">
		</table>
	</div>
</div>

<script>
	let lobby_socket;

	let lobby_name = "{{lobby_name}}";
	let history = [];
	let datetime;

	let game_message = document.getElementById("game_message");

	//Tables
	let players_table = document.getElementById("players_table");
	let spectators_table = document.getElementById("spectators_table");
	let history_table = document.getElementById("history_table");

	// Game
	let current_question = document.getElementById("current_question");
	let date_time = document.getElementById("date_time");
	let submit_answer = document.getElementById("submit_answer");

	// Login
	let when_connected = document.getElementById("when_connected");
	let current_pseudo = document.getElementById("current_pseudo");
	let leave_button = document.getElementById("leave_button");

	let when_disconnected = document.getElementById("when_disconnected");
	let pseudo_field = document.getElementById("pseudo_field");
	let join_button = document.getElementById("join_button");

	leave_button.addEventListener("click", leave);

	join_button.addEventListener("click", try_to_join);
	pseudo_field.addEventListener("keydown", function(e) {
		if (e.keyCode === 13) try_to_join();
	});

	pseudo_field.focus();

	try_to_connect();
	init_players_table();
	init_spectators_table();
	init_history_table();
	update_login_controls(false);

	window.setInterval(update_date_time, 99);

	lobby_socket.onmessage = function(e) {
		let message = JSON.parse(e.data);
		console.log(message);

		let data = message.data;
		datetime = Date.parse(data.datetime);
		switch (message._type) {
			case "state":
				update_game_status(data.state);
				break;
			case "scoreboard":
				update_players_table(data.players);
				update_spectators_table(data.spectators);
				update_history_table(data.history);
				break;
			case "waiting_for_players":
				update_waiting_for_players(data.qte);
				break;
			case "game_starts_soon":
				update_game_starts_soon();
				break;
			case "question":
				update_question(data.question);
				break;
			case "answer":
				update_answer(data.answer);
				break;
			case "game_end":
				update_game_end();
				break;
		}
	};

	lobby_socket.onclose = function(e) {
		console.error("Lobby socket closed unexpectedly");
	};

	submit_answer.addEventListener("keydown", function(e) {
		let message = e.srcElement.value;
		if (e.keyCode === 13 && message.length > 0) {
			send_answer(message);
			e.srcElement.value = "";
		}
	});

	function try_to_connect() {
		lobby_socket = new WebSocket("ws://" + window.location.host + "/lobby/" + lobby_name + "/");
	}

	function send_answer(answer) {
		lobby_socket.send(JSON.stringify({
			"type": "submit",
			"answer": answer,
		}));
	}

	function try_to_join(e) {
		let pseudo = pseudo_field.value;
		if (pseudo.length > 0) {
			join(pseudo);
		}
	}

	function join(pseudo) {
		update_login_controls(true);
		if (pseudo_field.value.length > 0) {
			lobby_socket.send(JSON.stringify({
				"type": "join",
				"pseudo": pseudo
			}));
		}
		$("#currentPseudo").text(pseudo); //using jquery to escape the pseudo client side
		submit_answer.focus();
		submit_answer.value = "";
	}

	function leave() {
		update_login_controls(false);
		lobby_socket.send(JSON.stringify({
			"type": "leave"
		}));
		pseudo_field.focus();
		pseudo_field.select();
	}

	function update_login_controls(connected) {
		when_connected.hidden = !connected;
		when_disconnected.hidden = connected;
		submit_answer.hidden = !connected;
	}

	function update_date_time() {
		let t = datetime - Date.now();
		//format
		let tsec = parseInt(t / 1000) + 1;
		if (tsec) {
			if (tsec >= 0) {
				date_time.innerHTML = tsec;
			} else {
				date_time.innerHTML = "Veuillez patienter...";
			}
		} else {
			date_time.innerHTML = "";
		}
	}

    // Update UI on messages

	function update_game_status(data) {
		update_time_end(data["questionDateTimeEnd"]);
		update_question(data["currentQuestion"]);
	}

	function update_question(question) {
		game_message.innerHTML = "";
		current_question.innerHTML = question;
		submit_answer.hidden = false;
		submit_answer.focus();
	}

	function update_answer(answer) {
		game_message.innerHTML = "La réponse était : " + answer;
		submit_answer.hidden = true;
	}

	function update_waiting_for_players(qte) {
		game_message.innerHTML = "En attente de la connexion de " + qte + " joueurs";
		submit_answer.hidden = true;
	}

	function update_game_starts_soon(qte) {
		game_message.innerHTML = "La partie va bientôt commencer !";
		submit_answer.hidden = true;
	}

    function update_game_end(){
        game_message.innerHTML = "La partie est terminée !"
		submit_answer.hidden = true;
    }

	// Tables

	function init_players_table() {
		players_table.innerHTML = '';
		players_table.appendChild(Tools.create_row(["#", "Joueur", "Score total", "Score sauce"], "th"));
	}

	function init_spectators_table() {
		spectators_table.innerHTML = '';
		spectators_table.appendChild(Tools.create_row(["Nom"], "th"));
	}

	function init_history_table() {
		history_table.innerHTML = '';
		history_table.appendChild(Tools.create_row(["Réponse", "Premier", "Deuxième", "Troisième"], "th"));
	}

	function update_players_table(p) {
		init_players_table();
		for (let i = 0; i < p.length; i++) {
			let row = p[i];
			players_table.appendChild(Tools.create_row([i + 1, row["name"], row.score, row.points_this_round == -1 ? "" : "+" + row.points_this_round]));
		}
	}

	function update_spectators_table(s) {
		init_spectators_table();
		for (let i = 0; i < s.length; i++) {
			let row = s[i];
			spectators_table.appendChild(Tools.create_row([row["name"]]));
		}
	}

	function update_history_table(h) {
		init_history_table();
		for (let i = 0; i < h.length; i++) {
			let row = h[i];
			history_table.appendChild(Tools.create_row([i + 1, row["name"]]));
		}
	}
</script>
{% endblock %}
