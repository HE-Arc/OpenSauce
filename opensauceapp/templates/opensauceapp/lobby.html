{% extends "opensauceapp/base.html" %}
{% block title %}Lobby {% endblock %}

{% block content %}
<style>
	html, body {
        width:100%;
        height:100%;
    }
    #leftContainer {
        float:left;
        width: 70%;
        height: 100%;
        margin:0;
    }
    #rightContainer {
        float:right;
        width: 30%;
        height: 100%;
        margin:0;
    }
    #header {

    }

    #currentQuestion {
        height: 80%;
        text-align: center;
        font-size: 50px;
    }

    #submitAnswer {
        width: 100%;
        margin: 50px;
        font-size: 2em;
        text-align: center;
        border-radius: 25px;
        background-color:black;
        color:white;
        text-transform: uppercase;
    }

    #scoreBoard, #historyTable {
        width:100%;
    }
</style>
<div id="leftContainer">
	<div id="header">
		<div id="lobbyName">
			{% autoescape on %}
			{{lobby_name}}
			{% endautoescape %}
		</div>
	</div>

	<div id="category">

	</div>
	<div id="remainingTime">

	</div>
	<div id="currentQuestion">

	</div>

	<input id="submitAnswer" type="text" hidden>
</div>
<div id="rightContainer">
    <span id="whenDisconnected">
        Nom : <input id="pseudoField" type="text" placeholder="john">
    	<input id="joinButton" type="button" value="Rejoindre">
    </span>
    <span id="whenConnected" hidden>
        Connecté en tant que : <span id="currentPseudo"></span>
    	<input id="leaveButton" type="button" value="Quitter">
    </span>
	<div id="scoreBoard-container">
		<p class="h3">Classement</p>
		<table id="scoreBoard" class="table">
		</table>
	</div>
	<div id="history-container">
		<p class="h3">Historique</p>
		<table id="historyTable" class="table">
		</table>
	</div>
</div>

<script>
    let lobbySocket;

	let lobbyName = "{{lobby_name}}";
    let history = [];
	let currentTimeEnd;


    //Game
	let scoreBoard = document.getElementById("scoreBoard");
	let historyTable = document.getElementById("historyTable");
	let currentQuestion = document.getElementById("currentQuestion");
	let remainingTime = document.getElementById("remainingTime");

    let submitAnswer = document.getElementById("submitAnswer");

    // Login
	let whenConnected = document.getElementById("whenConnected");
	let currentPseudo = document.getElementById("currentPseudo");
    let leaveButton = document.getElementById("leaveButton");

	let whenDisconnected = document.getElementById("whenDisconnected");
    let pseudoField = document.getElementById("pseudoField");
	let joinButton = document.getElementById("joinButton");

	leaveButton.addEventListener("click", leave);

    joinButton.addEventListener("click", tryToJoin);
    pseudoField.addEventListener("keydown", function(e) {if(e.keyCode === 13) tryToJoin();});

	pseudoField.focus();

    tryToConnect();
    initScoreboard();
    initHistoryTable();
	updateLoginControls(false);

    window.setInterval(updateRemainingTime, 99);

	lobbySocket.onmessage = function(e) {
		let data = JSON.parse(e.data);
		console.log("message");
		console.log(data);
		if (data.type == "game_state") {
			updateGameStatus(data.state);
		}
	};

	lobbySocket.onclose = function(e) {
		console.error("Lobby socket closed unexpectedly");
	};

	submitAnswer.addEventListener("keydown", function(e) {
		let message = e.srcElement.value;
		if (e.keyCode === 13 && message.length > 0) {
			sendAnswer(message);
			e.srcElement.value = "";
		}
	});

    function tryToConnect() {
        lobbySocket = new WebSocket("ws://" + window.location.host + "/lobby/" + lobbyName + "/");
    }

	function sendAnswer(answer) {
		lobbySocket.send(JSON.stringify({
			"type": "submit",
			"answer": answer,
		}));
	}

    function tryToJoin(e){
        let pseudo = pseudoField.value;
		if (pseudo.length > 0) {
			join(pseudo);
		}
    }

	function join(pseudo) {
		updateLoginControls(true);
		if (pseudoField.value.length > 0) {
			lobbySocket.send(JSON.stringify({
				"type": "join",
				"pseudo": pseudo
			}));
		}
        $("#currentPseudo").text(pseudo); //using jquery to escape the pseudo client side
		submitAnswer.focus();
		submitAnswer.value = "";
	}

	function leave() {
		updateLoginControls(false);
		lobbySocket.send(JSON.stringify({
			"type": "leave"
		}));
		pseudoField.focus();
		pseudoField.select();
	}

	function updateLoginControls(connected) {
		whenConnected.hidden = !connected;
		whenDisconnected.hidden = connected;
		submitAnswer.hidden = !connected;
	}

    function updateRemainingTime() {
        let t = currentTimeEnd - Date.now();
        //format
        let tsec = ("" + t / 1000).split(".");
        let sec = tsec[0];
        let mil = tsec[1];
        if(t >= 0)
        {
            remainingTime.innerHTML = sec + "." + mil[0];
            //submitAnswer.disabled = false;
        }
        else
        {
            //submitAnswer.disabled = true;
        }
    }

	function updateGameStatus(data) {
		updateScoreBoard(data["players"]);
		updateTimeEnd(data["questionDateTimeEnd"]);
		updateQuestion(data["currentQuestion"]);
	}

	function updateScoreBoard(players) {
		initScoreboard();
		for (let i = 0; i < players.length; i++) {
			let player = players[i];
			scoreBoard.appendChild(createRow([i+1, player["name"], player.score, player.pointsThisRound == -1 ? "" : "+" + player.pointsThisRound]));
		}
	}

	function updateTimeEnd(timeEnd) {
		currentTimeEnd = Date.parse(timeEnd);
	}

	function updateQuestion(question) {
		currentQuestion.innerHTML = question;
	}

	function initScoreboard() {
		scoreBoard.innerHTML = '';
		scoreBoard.appendChild(createRow(["#", "Joueur", "Score total", "Score sauce"], "th"));
	}

    function initHistoryTable() {
		historyTable.innerHTML = '';
		historyTable.appendChild(createRow(["Réponse", "Premier", "Deuxième", "Troisième"], "th"));
	}

	function createRow(values, type = "td") {
		let tr = document.createElement("tr");
		for (let i = 0; i < values.length; i++) {
			let td = document.createElement(type);
			td.innerHTML = values[i];
			tr.appendChild(td);
		}
		return tr;
	}
</script>
{% endblock %}
